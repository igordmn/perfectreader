<html xmlns="http://www.w3.org/1999/xhtml">
<head>
</head>
<body style="padding:0; margin:0;">
<div style="overflow:hidden;">
    <div style="-webkit-margin-top-collapse: discard"></div>
    <div id="contentContainer" style="width: 640px; zoom:0.5"></div>
    <div style="-webkit-margin-bottom-collapse: discard"></div>
</div>
<div style="position:fixed; left:290px; top:0px; width:70px; z-index: 1; background-color:#BBBBBB; opacity:0.9">
    <button id="fastButton" onclick="toggleFast()" style="width:60px; height: 50px; margin:5px;">SLOW</button>
    <button onclick="topDec()" style="width:60px; height: 50px; margin:5px;">TOP-</button>
    <button onclick="topInc()" style="width:60px; height: 50px; margin:5px;">TOP+</button>
    <button onclick="bottomDec()" style="width:60px; height: 50px; margin:5px;">BOT-</button>
    <button onclick="bottomInc()" style="width:60px; height: 50px; margin:5px; ">BOT+</button>
    <button onclick="scrollUpper()" style="width:60px; height: 50px; margin:5px; ">SCRL-</button>
    <button onclick="scrollLower()" style="width:60px; height: 50px; margin:5px; ">SCRL+</button>
</div>

<script type="text/javascript" src="../../../../main/assets/pagebook/js/global.js"></script>
<script type="text/javascript" src="../../../../main/assets/pagebook/js/utils/require.js"></script>
<script type="text/javascript" src="../../../../main/assets/pagebook/js/utils/element.js"></script>
<script type="text/javascript" src="../../../../main/assets/pagebook/js/utils/promise.js"></script>
<script type="text/javascript" src="../../../../main/assets/pagebook/js/utils/search.js"></script>
<script type="text/javascript" src="../../../../main/assets/pagebook/js/utils/style.js"></script>
<script type="text/javascript" src="../../../../main/assets/pagebook/js/piece/content-info.js"></script>
<script type="text/javascript" src="../../../../main/assets/pagebook/js/piece/piece.js"></script>
<script type="text/javascript" src="../../../../main/assets/pagebook/js/piece/calculator.js"></script>
<script type="text/javascript" src="../../../../main/assets/pagebook/js/piece/splitter.js"></script>
<script type="text/javascript" src="../../../../main/assets/pagebook/js/piece/transformer.js"></script>
<script type="text/javascript" src="../../../../main/assets/pagebook/js/piece/importer.js"></script>
<script type="text/javascript" src="../../../../main/assets/pagebook/js/piece/piece-loader.js"></script>
<script type="text/javascript" src="../../../../main/assets/pagebook/js/book-content.js"></script>
<script type="text/javascript" src="../../../../main/assets/pagebook/js/piece-view.js"></script>
<script type="text/javascript" src="../../../../main/assets/pagebook/js/paginator.js"></script>

<script type="text/javascript" src="assets://pagebook/js/global.js"></script>
<script type="text/javascript" src="assets://pagebook/js/utils/require.js"></script>
<script type="text/javascript" src="assets://pagebook/js/utils/element.js"></script>
<script type="text/javascript" src="assets://pagebook/js/utils/promise.js"></script>
<script type="text/javascript" src="assets://pagebook/js/utils/search.js"></script>
<script type="text/javascript" src="assets://pagebook/js/utils/style.js"></script>
<script type="text/javascript" src="assets://pagebook/js/piece/content-info.js"></script>
<script type="text/javascript" src="assets://pagebook/js/piece/piece.js"></script>
<script type="text/javascript" src="assets://pagebook/js/piece/calculator.js"></script>
<script type="text/javascript" src="assets://pagebook/js/piece/splitter.js"></script>
<script type="text/javascript" src="assets://pagebook/js/piece/transformer.js"></script>
<script type="text/javascript" src="assets://pagebook/js/piece/importer.js"></script>
<script type="text/javascript" src="assets://pagebook/js/piece/piece-loader.js"></script>
<script type="text/javascript" src="assets://pagebook/js/book-content.js"></script>
<script type="text/javascript" src="assets://pagebook/js/piece-view.js"></script>
<script type="text/javascript" src="assets://pagebook/js/paginator.js"></script>

<script type="text/javascript" src="utils/test.js"></script>

<script type="text/javascript">
"use strict";

const Test = require("utils/test");
const PromiseUtils = require("utils/promise");
const Piece = require("piece/piece");
const PieceView = require("piece-view");
const Importer = require("piece/importer");
const Calculator = require("piece/calculator");

const createPieceByNodes = Piece.createPieceByNodes.bind(Importer);
const importContent = Importer.importContent.bind(Importer);
const calculateEdges = Calculator.calculateEdges.bind(Calculator);
const bench = Test.bench.bind(Test);
const async = PromiseUtils.async;

// For desktop test
if (!Element.prototype.typoGetLineRects) {
    Element.prototype.typoGetLineRects = function() { return []; }
}
if (!CSSStyleDeclaration.prototype.typoHiddenLinesTop) {
    Object.defineProperty(CSSStyleDeclaration.prototype, "typoHiddenLinesTop", { value: "", writable:true });
}
if (!CSSStyleDeclaration.prototype.typoHiddenLinesBottom) {
    Object.defineProperty(CSSStyleDeclaration.prototype, "typoHiddenLinesBottom", { value: "", writable:true });
}

const CONTENT_SRC_1 = "test-content-1.html";
const CONTENT_SRC_2 = "test-content-2.html";
const CONTENT_SRC_3 = "../testbooks/extracted/carrollAliceInWonderland/@public@vhost@g@gutenberg@html@files@28885@28885-h@28885-h-12.htm.html";
const CONTENT_SRC = CONTENT_SRC_1;

let pieceView;

loadElement(initPieceView);

function loadElement(onload) {
    var xhr = new XMLHttpRequest();
    xhr.onload = function() {
        onload(this.responseXML);
    }
    xhr.open("GET", CONTENT_SRC);
    xhr.responseType = "document";
    xhr.send();
}

function initPieceView(doc) {
    const body = importContent(doc);
    calculateEdges(body, 0.0, 1.0);

    const contentContainer = document.getElementById("contentContainer");

    document.body.clientWidth;
    var t1 = new Date().getTime();

    const piece = createPieceByNodes(body, body.firstChild, body.lastChild);
    PieceView.insert(piece.createFragment(), contentContainer, 0, 800).then(function(newPieceView) {
        document.body.clientWidth;
        var t2 = new Date().getTime();
        console.log("insert time: " + (t2-t1));

        pieceView = newPieceView;
    });
}

let delta = 10;

function toggleFast() {
    document.getElementById("fastButton").firstChild.nodeValue = delta == 1 ? "SLOW" : "FAST";
    delta = delta == 1 ? 10 : 1;
}

function topDec() {
    bench("shift", function() {
        if (pieceView.beginIndex - delta >= 0) pieceView.beginIndex -= delta;
    });
}

function topInc() {
    bench("shift", function() {
        if (pieceView.beginIndex + delta <= pieceView.endIndex) pieceView.beginIndex += delta;
    });
}

function bottomDec() {
    bench("shift", function() {
        if (pieceView.endIndex - delta >= pieceView.beginIndex) pieceView.endIndex -= delta;
    });
}

function bottomInc() {
    bench("shift", function() {
        if (pieceView.endIndex + delta <= pieceView.length) pieceView.endIndex += delta;
    });
}

function scrollUpper() {
    scrollTo(0, document.body.scrollTop - 200)
}

function scrollLower() {
    scrollTo(0, document.body.scrollTop + 200)
}

</script>
</body>
</html>
