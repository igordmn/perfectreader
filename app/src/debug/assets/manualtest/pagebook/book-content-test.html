<html xmlns="http://www.w3.org/1999/xhtml">
<head>
</head>
<body style="padding:0; margin:0;">

<script type="text/javascript" src="../../../../main/assets/pagebook/js/global.js"></script>
<script type="text/javascript" src="../../../../main/assets/pagebook/js/utils/require.js"></script>
<script type="text/javascript" src="../../../../main/assets/pagebook/js/utils/element.js"></script>
<script type="text/javascript" src="../../../../main/assets/pagebook/js/utils/promise.js"></script>
<script type="text/javascript" src="../../../../main/assets/pagebook/js/utils/search.js"></script>
<script type="text/javascript" src="../../../../main/assets/pagebook/js/utils/style.js"></script>
<script type="text/javascript" src="../../../../main/assets/pagebook/js/piece/content-info.js"></script>
<script type="text/javascript" src="../../../../main/assets/pagebook/js/piece/piece.js"></script>
<script type="text/javascript" src="../../../../main/assets/pagebook/js/piece/calculator.js"></script>
<script type="text/javascript" src="../../../../main/assets/pagebook/js/piece/splitter.js"></script>
<script type="text/javascript" src="../../../../main/assets/pagebook/js/piece/transformer.js"></script>
<script type="text/javascript" src="../../../../main/assets/pagebook/js/piece/importer.js"></script>
<script type="text/javascript" src="../../../../main/assets/pagebook/js/piece/piece-loader.js"></script>
<script type="text/javascript" src="../../../../main/assets/pagebook/js/book-content.js"></script>
<script type="text/javascript" src="../../../../main/assets/pagebook/js/piece-view.js"></script>
<script type="text/javascript" src="../../../../main/assets/pagebook/js/paginator.js"></script>

<script type="text/javascript" src="assets://pagebook/js/global.js"></script>
<script type="text/javascript" src="assets://pagebook/js/utils/require.js"></script>
<script type="text/javascript" src="assets://pagebook/js/utils/element.js"></script>
<script type="text/javascript" src="assets://pagebook/js/utils/promise.js"></script>
<script type="text/javascript" src="assets://pagebook/js/utils/search.js"></script>
<script type="text/javascript" src="assets://pagebook/js/utils/style.js"></script>
<script type="text/javascript" src="assets://pagebook/js/piece/content-info.js"></script>
<script type="text/javascript" src="assets://pagebook/js/piece/piece.js"></script>
<script type="text/javascript" src="assets://pagebook/js/piece/calculator.js"></script>
<script type="text/javascript" src="assets://pagebook/js/piece/splitter.js"></script>
<script type="text/javascript" src="assets://pagebook/js/piece/transformer.js"></script>
<script type="text/javascript" src="assets://pagebook/js/piece/importer.js"></script>
<script type="text/javascript" src="assets://pagebook/js/piece/piece-loader.js"></script>
<script type="text/javascript" src="assets://pagebook/js/book-content.js"></script>
<script type="text/javascript" src="assets://pagebook/js/piece-view.js"></script>
<script type="text/javascript" src="assets://pagebook/js/paginator.js"></script>

<script type="text/javascript" src="utils/test.js"></script>

<script type="text/javascript">
"use strict";

const TestUtils = require("utils/test");
const PromiseUtils = require("utils/promise");
const BookContent = require("book-content");

const async = PromiseUtils.async.bind(PromiseUtils);
const runAsyncTest = TestUtils.runAsyncTest.bind(TestUtils);
const assertNotNull = TestUtils.assertNotNull.bind(TestUtils);
const assertEquals = TestUtils.assertEquals.bind(TestUtils);
const assertFloatEquals = TestUtils.assertFloatEquals.bind(TestUtils);
const pseudoRandom = TestUtils.pseudoRandom.bind(TestUtils);
const createBookContent = BookContent.createBookContent.bind(BookContent);

const bookSource = {
    segments: [
        { src: "../testbooks/extracted/carrollAliceInWonderland/wrap0000.html", sizeInBytes: 1 },
        { src: "../testbooks/extracted/carrollAliceInWonderland/@public@vhost@g@gutenberg@html@files@28885@28885-h@28885-h-0.htm.html", sizeInBytes: 1 },
        { src: "../testbooks/extracted/carrollAliceInWonderland/@public@vhost@g@gutenberg@html@files@28885@28885-h@28885-h-1.htm.html", sizeInBytes: 1 },
        { src: "../testbooks/extracted/carrollAliceInWonderland/@public@vhost@g@gutenberg@html@files@28885@28885-h@28885-h-2.htm.html", sizeInBytes: 1 },
        { src: "../testbooks/extracted/carrollAliceInWonderland/@public@vhost@g@gutenberg@html@files@28885@28885-h@28885-h-3.htm.html", sizeInBytes: 1 },
        { src: "../testbooks/extracted/carrollAliceInWonderland/@public@vhost@g@gutenberg@html@files@28885@28885-h@28885-h-4.htm.html", sizeInBytes: 1 },
        { src: "../testbooks/extracted/carrollAliceInWonderland/@public@vhost@g@gutenberg@html@files@28885@28885-h@28885-h-5.htm.html", sizeInBytes: 1 },
        { src: "../testbooks/extracted/carrollAliceInWonderland/@public@vhost@g@gutenberg@html@files@28885@28885-h@28885-h-6.htm.html", sizeInBytes: 1 },
        { src: "../testbooks/extracted/carrollAliceInWonderland/@public@vhost@g@gutenberg@html@files@28885@28885-h@28885-h-7.htm.html", sizeInBytes: 1 },
        { src: "../testbooks/extracted/carrollAliceInWonderland/@public@vhost@g@gutenberg@html@files@28885@28885-h@28885-h-8.htm.html", sizeInBytes: 1 },
        { src: "../testbooks/extracted/carrollAliceInWonderland/@public@vhost@g@gutenberg@html@files@28885@28885-h@28885-h-9.htm.html", sizeInBytes: 1 },
        { src: "../testbooks/extracted/carrollAliceInWonderland/@public@vhost@g@gutenberg@html@files@28885@28885-h@28885-h-10.htm.html", sizeInBytes: 1 },
        { src: "../testbooks/extracted/carrollAliceInWonderland/@public@vhost@g@gutenberg@html@files@28885@28885-h@28885-h-11.htm.html", sizeInBytes: 1 },
        { src: "../testbooks/extracted/carrollAliceInWonderland/@public@vhost@g@gutenberg@html@files@28885@28885-h@28885-h-12.htm.html", sizeInBytes: 1 },
    ],
};

const bookContent = createBookContent(bookSource);

async(function*() {
    assertEquals(false, bookContent.isSegmentLoaded(0), "bookContent.isSegmentLoaded(0)");
    assertEquals(false, bookContent.isSegmentLoaded(1), "bookContent.isSegmentLoaded(1)");

    const piece1first = yield bookContent.getPieceAt(1 / bookSource.segments.length);
    assertFloatEquals(1 / bookSource.segments.length, piece1first.beginPercent, 6, "piece1first.beginPercent");
    assertEquals(false, bookContent.isSegmentLoaded(0), "bookContent.isSegmentLoaded(0)");
    assertEquals(true, bookContent.isSegmentLoaded(1), "bookContent.isSegmentLoaded(1)");

    const piece0last = yield bookContent.getPieceAt(1 / bookSource.segments.length - 0.01);
    assertFloatEquals(1 / bookSource.segments.length, piece0last.endPercent, 6, "piece0last.endPercent");
    assertEquals(piece0last.endPercent, piece1first.beginPercent, "piece0last.beginPercent == piece1first.endPercent");
    assertEquals(true, bookContent.isSegmentLoaded(0), "bookContent.isSegmentLoaded(0)");
    assertEquals(true, bookContent.isSegmentLoaded(1), "bookContent.isSegmentLoaded(1)");

    const piece0last2 = yield bookContent.getPreviousPiece(piece1first);
    const piece1first2 = yield bookContent.getNextPiece(piece0last2);
    assertEquals(piece0last, piece0last2, "piece0last == piece0last2");
    assertEquals(piece1first, piece1first2, "piece1first == piece1first2");

    assertEquals(true, bookContent.hasNextPiece(piece1first2));
    const nextPiece = yield bookContent.getNextPiece(piece1first2);
    bookContent.releasePiece(nextPiece);

    assertEquals(true, bookContent.isSegmentLoaded(0), "bookContent.isSegmentLoaded(0)");
    bookContent.releasePiece(piece0last);
    assertEquals(true, bookContent.isSegmentLoaded(0), "bookContent.isSegmentLoaded(0)");
    bookContent.releasePiece(piece0last2);
    assertEquals(false, bookContent.isSegmentLoaded(0), "bookContent.isSegmentLoaded(0)");

    assertEquals(true, bookContent.isSegmentLoaded(1), "bookContent.isSegmentLoaded(1)");
    bookContent.releasePiece(piece1first);
    assertEquals(true, bookContent.isSegmentLoaded(1), "bookContent.isSegmentLoaded(1)");
    bookContent.releasePiece(piece1first2);
    assertEquals(false, bookContent.isSegmentLoaded(1), "bookContent.isSegmentLoaded(1)");

    const pieceFirst = yield bookContent.getPieceAt(0.0);
    assertEquals(0.0, pieceFirst.beginPercent, "pieceFirst.beginPercent");
    assertEquals(false, bookContent.hasPreviousPiece(pieceFirst), "bookContent.hasPreviousPiece(pieceFirst)");
    bookContent.releasePiece(pieceFirst);

    const pieceLast = yield bookContent.getPieceAt(1.0);
    const pieceBeforeLast = yield bookContent.getPreviousPiece(pieceLast);
    assertEquals(1.0, pieceLast.endPercent, "pieceLast.endPercent");
    assertEquals(true, bookContent.hasNextPiece(pieceBeforeLast), "bookContent.hasNextPiece(pieceBeforeLast)");
    assertEquals(false, bookContent.hasNextPiece(pieceLast), "bookContent.hasNextPiece(pieceLast)");
    bookContent.releasePiece(pieceLast);
    bookContent.releasePiece(pieceBeforeLast);

    runAsyncTest("many calls of getPiece", function(onOK) {
        for (let i = 0; i < bookSource.segments.length; i++) {
            assertEquals(false, bookContent.isSegmentLoaded(i), "bookContent.isSegmentLoaded(" + i + ")");
        }

        let piecePromises = [];
        for (let i = 0; i < 200; i++) {
            piecePromises.push(bookContent.getPieceAt(pseudoRandom()));
        }

        Promise.all(piecePromises).then(function(pieces) {
            for (let piece of pieces) {
                assertNotNull(piece, "piece should be not null");
                bookContent.releasePiece(piece);
            }

            for (let i = 0; i < bookSource.segments.length; i++) {
                assertEquals(false, bookContent.isSegmentLoaded(i), "bookContent.isSegmentLoaded(" + i +")");
            }

            onOK();
        });
    });
});

</script>
</body>
</html>
