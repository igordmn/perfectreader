<?xml version="1.0" encoding="UTF-8"?>
<html>
<head>
    <meta HTTP-EQUIV="content-type" CONTENT="text/html; charset=UTF-8"/>
</head>
<body style="padding: 0; margin: 0; overflow:hidden;">

<div id="mainContainer" style="position: relative; overflow: hidden; padding: 0; margin: 0;">
    <div style="position: absolute; padding: 0; margin: 0; color: white">
        <iframe id="firstFrame" scrolling="no" style="visibility: hidden; width: 100%; height: 100%; border: 0"></iframe>
    </div>
    <div style="position: absolute; padding: 0; margin: 0; color: white">
        <iframe id="secondFrame" scrolling="no" style="visibility: hidden; width: 100%; height: 100%; border: 0"></iframe>
    </div>
    <div style="position: absolute; padding: 0; margin: 0; color: white">
        <iframe id="thirdFrame" scrolling="no" style="visibility: hidden; width: 100%; height: 100%; border: 0"></iframe>
    </div>
</div>

<script type="text/javascript" src="utils/dom.js"></script>
<script type="text/javascript" src="utils/format.js"></script>
<script type="text/javascript" src="utils/string.js"></script>
<script type="text/javascript" src="utils/style.js"></script>
<script type="text/javascript" src="utils/regexp.js"></script>
<script type="text/javascript" src="utils/object.js"></script>
<script type="text/javascript" src="utils/set.js"></script>
<script type="text/javascript" src="utils/render.js"></script>
<script type="text/javascript">

var ZERO_PERCENT = 0;
var ONE_HUNDRED_PERCENT = 0x7fffffff;

window.onload = function() {
    var settings = {
        segmentUrls: [],
        callback: undefined,
    };

    var bookConfig = {
        paddingTopInPixels: 10,
        paddingRightInPixels: 10,
        paddingBottomInPixels: 10,
        paddingLeftInPixels: 10,

        textAlign: "justify",
        fontSizeInPercents: 100,

        deleteRedundantSpaces: true,
        replaceFixedSpaces: true
    }

    var mainContainer = document.getElementById("mainContainer");
    var currentFrame = document.getElementById("firstFrame");
    var nextFrame = document.getElementById("secondFrame");
    var previewFrame = document.getElementById("thirdFrame");
    var screenWidth = window.innerWidth;
    var screenHeight = window.innerHeight;

    initViewport();

    var loadActionCount = 0;

    var reader = window.reader = {
        currentLocation: undefined,

        setSegmentUrls: function(segmentUrls) {
            settings.segmentUrls = segmentUrls;
        },

        setCallback: function(callback) {
            settings.callback = callback;
        },

        canGoNextPage: function() {
            return currentFrame.reader &&
                    (
                        this.currentLocation && this.currentLocation.segmentIndex < settings.segmentUrls.length - 1 ||
                        currentFrame.reader.canGoNextPage()
                    );
        },

        canGoPreviewPage: function() {
            return currentFrame.reader &&
                    (
                        this.currentLocation && this.currentLocation.segmentIndex > 0 ||
                        currentFrame.reader.canGoPreviewPage()
                    );
        },

        goLocation: function(location) {
            settings.callback.beforeGoLocation();
            beforeLoad();
            this.currentLocation = location;
            loadSegment(currentFrame, currentUrl(this.currentLocation), this.currentLocation.percent);
            loadSegment(nextFrame, nextUrl(this.currentLocation), ZERO_PERCENT);
            loadSegment(previewFrame, previewUrl(this.currentLocation), ONE_HUNDRED_PERCENT);
        },

        goNextPage: function() {
            if (this.canGoNextPage()) {
                settings.callback.beforeGoNextPage();
                beforeLoad();

                var currentReader = currentFrame.reader;
                if (currentReader.canGoNextPage()) {
                    currentReader.goNextPage();
                    this.currentLocation.percent = currentReader.currentPercent;
                } else {
                    var oldCurrentFrame = currentFrame;
                    currentFrame = nextFrame;
                    nextFrame = previewFrame;
                    previewFrame = oldCurrentFrame;
                    this.currentLocation.segmentIndex++;
                    this.currentLocation.percent = ZERO_PERCENT;

                    loadSegment(nextFrame, nextUrl(this.currentLocation), ZERO_PERCENT);
                }
            }
        },

        goPreviewPage: function() {
            if (this.canGoPreviewPage()) {
                settings.callback.beforeGoPreviewPage();
                beforeLoad();

                var currentReader = currentFrame.reader;
                if (currentReader.canGoPreviewPage()) {
                    currentReader.goPreviewPage();
                    this.currentLocation.percent = currentReader.currentPercent;
                } else {
                    var oldCurrentFrame = currentFrame;
                    currentFrame = previewFrame;
                    previewFrame = nextFrame;
                    nextFrame = oldCurrentFrame;
                    this.currentLocation.segmentIndex--;
                    this.currentLocation.percent = ONE_HUNDRED_PERCENT;

                    loadSegment(previewFrame, previewUrl(this.currentLocation), ONE_HUNDRED_PERCENT);
                }
            }
        },

        setPadding: function(textAlign) {
            bookConfig.paddingTopInPixels = paddingTopInPixels;
            bookConfig.paddingRightInPixels = paddingRightInPixels;
            bookConfig.paddingBottomInPixels = paddingBottomInPixels;
            bookConfig.paddingLeftInPixels = paddingLeftInPixels;
            callReflow(function(reader) {
                reader.refreshPageConfiguration();
            });
        },

        setTextAlign: function(textAlign) {
            bookConfig.textAlign = textAlign;
            callReflow(function(reader) {
                reader.refreshTextAlign();
            });
        },

        setFontSize: function(fontSizeInPercents) {
            bookConfig.fontSizeInPercents = fontSizeInPercents;
            callReflow(function(reader) {
                reader.refreshFontSize();
            });
        },

        setDeleteRedundantSpaces: function(deleteRedundantSpaces) {
            bookConfig.deleteRedundantSpaces = deleteRedundantSpaces;
            reload();
        },

        setReplaceFixedSpaces: function(replaceFixedSpaces) {
            bookConfig.replaceFixedSpaces = replaceFixedSpaces;
            reload();
        }
    }

    function currentUrl(location) {
        return settings.segmentUrls[location.segmentIndex];;
    }

    function nextUrl(location) {
        return location.segmentIndex < settings.segmentUrls.length - 1 ?
                settings.segmentUrls[location.segmentIndex + 1] :
                "about:blank";
    }

    function previewUrl(location) {
        return location.segmentIndex > 0 ?
                settings.segmentUrls[location.segmentIndex - 1] :
                "about:blank";
    }

    function callReflow(refreshFunction) {
        beforeLoad();
        resetViewportForReflow();
        if (currentFrame.reader) {
            refreshFunction(currentFrame.reader);
            currentFrame.reader.reflow();
        }
        if (nextFrame.reader) {
            refreshFunction(nextFrame.reader);
            nextFrame.reader.reflow();
        }
        if (previewFrame.reader) {
            refreshFunction(previewFrame.reader);
            previewFrame.reader.reflow();
        }
    }

    function reload() {
        reader.goLocation(reader.currentLocation);
    }

    function onSegmentPageChanged() {
        updateViewport();
        if (isAfterLoad()) {
            afterLoad();
        }
    }

    function isAfterLoad() {
        return loadActionCount > 0 && currentFrame.reader && nextFrame.reader && previewFrame.reader;
    }

    function beforeLoad() {
        loadActionCount++;
        settings.callback.beforeLoad();
    }
    
    function afterLoad() {
        for (var i = 0; i < loadActionCount; i++) {
            settings.callback.afterLoad();
        }
        loadActionCount = 0;
        repaint(document.body); // для того, чтобы вызвался invalidate для WebView в Android (см. com.dmi.perfectreader.bookview.PageBookView.MyWebView.invalidate)
    }

    function initViewport() {
        currentFrame.parentNode.style.width = 0;
        currentFrame.parentNode.style.height = screenHeight;
        currentFrame.parentNode.style.left = -3 * screenWidth;
        currentFrame.parentNode.style.top = 0;
        currentFrame.parentNode.style.zIndex = 0;
        nextFrame.parentNode.style.width = screenWidth;
        nextFrame.parentNode.style.height = screenHeight;
        nextFrame.parentNode.style.left = -screenWidth;
        nextFrame.parentNode.style.top = 0;
        nextFrame.parentNode.style.zIndex = 1;
        previewFrame.parentNode.style.width = screenWidth;
        previewFrame.parentNode.style.height = screenHeight;
        previewFrame.parentNode.style.left = -screenWidth;
        previewFrame.parentNode.style.top = 0;
        previewFrame.parentNode.style.zIndex = 1;
        mainContainer.style.width = 3 * screenWidth;
        mainContainer.style.height = screenHeight;
        window.scrollTo(screenWidth, screenHeight);
    }

    function updateViewport() {
        var currentReader = currentFrame.reader;
        var nextReader = nextFrame.reader;
        var previewReader = previewFrame.reader;

        currentStyle = currentFrame.parentNode.style;
        nextStyle = nextFrame.parentNode.style;
        previewStyle = previewFrame.parentNode.style;

        currentStyle.width = 3 * screenWidth;
        nextStyle.width = screenWidth;
        previewStyle.width = screenWidth;

        if (currentReader) {
            var page = currentReader.currentPage;
            var pageCount = currentReader.pageCount;
            var onFirstPartOfFrame = page == 0;
            var onThirdPartOfFrame = (pageCount >= 3 && page == pageCount - 1);
            if (onFirstPartOfFrame) {
                currentStyle.left = screenWidth;
            } else if (onThirdPartOfFrame) {
                currentStyle.left = -screenWidth;
            } else {
                currentStyle.left = 0;
            }
        } else {
            currentStyle.left = -3 * screenWidth;
        }

        if (nextReader && (currentReader && !currentReader.canGoNextPage() || !currentReader)) {
            nextStyle.left = 2 * screenWidth;
        } else {
            nextStyle.left = -screenWidth;
        }

        if (previewReader && (currentReader && !currentReader.canGoPreviewPage() || !currentReader)) {
            previewStyle.left = 0;
        } else {
            previewStyle.left = -screenWidth;
        }

        currentReader && currentFrame.contentWindow.scrollTo(currentReader && (page - 1) * screenWidth, 0);
        nextReader && nextFrame.contentWindow.scrollTo(nextReader.currentPage * screenWidth, 0);
        previewReader && previewFrame.contentWindow.scrollTo(previewReader.currentPage * screenWidth, 0);
    }

    function resetViewportForReflow() {
        currentFrame.parentNode.style.width = screenWidth;
    }

    function loadSegment(frame, segmentUrl, percent) {
        frame.style.visibility = "hidden";
        frame.reader = undefined;
        frame.onload = function() {
            resetViewportForReflow();
            initFrameContent(frame, percent);
            frame.style.visibility = "";
        }
        frame.src = segmentUrl;
    }

    function initFrameContent(frame, percent) {
        var window = frame.contentWindow;
        var document = window.document;

        var stylesheet = createStylesheet(document);
        var styles = {
            p: addCSSStyle(stylesheet, "p"),
            div: addCSSStyle(stylesheet, "div"),
            td: addCSSStyle(stylesheet, "td"),
            dt: addCSSStyle(stylesheet, "dt"),
            dd: addCSSStyle(stylesheet, "dd"),
            br: addCSSStyle(stylesheet, "br"),
            li: addCSSStyle(stylesheet, "li"),
            fixSpace: addCSSStyle(stylesheet, ".fixSpace", "display: inline-block; width: 0.25em; text-indent: 0; padding: 0; margin: 0")
        };

        var frameReader = frame.reader = {
            pageCount: 0,
            currentPage: 0,
            currentPercent: percent,

            goPercent: function(percent) {
                this.currentPercent = percent;
                refreshCurrentPage();
            },

            goPage: function(page) {
                this.goPercent((page / this.pageCount) * ONE_HUNDRED_PERCENT);
            },

            canGoNextPage: function() {
                return this.currentPage < this.pageCount - 1;
            },

            canGoPreviewPage: function() {
                return this.currentPage > 0;
            },

            goNextPage: function() {
                this.goPage(this.currentPage + 1);
            },

            goPreviewPage: function() {
                this.goPage(this.currentPage - 1);
            },

            refreshPageConfiguration: function() {
                var wrapDiv = document.createElement("div");
                while (document.body.firstChild) {
                    wrapDiv.appendChild(document.body.firstChild);
                }
                document.body.appendChild(wrapDiv);

                document.body.style.setProperty("margin-top", bookConfig.paddingTopInPixels + "px", "important");
                document.body.style.setProperty("margin-bottom", bookConfig.paddingBottomInPixels + "px", "important");
                document.body.style.setProperty("margin-right", "0px", "important");
                document.body.style.setProperty("margin-left", "0px", "important");
                document.body.style.setProperty("padding", "0", "important");

                wrapDiv.style.setProperty("margin-top", "0px", "important");
                wrapDiv.style.setProperty("margin-bottom", "0px", "important");
                wrapDiv.style.setProperty("margin-right", bookConfig.paddingRightInPixels + "px", "important");
                wrapDiv.style.setProperty("margin-left", bookConfig.paddingLeftInPixels + "px", "important");
                wrapDiv.style.setProperty("padding", "0", "important");

                var width = screenWidth;
                var height = screenHeight - bookConfig.paddingTopInPixels - bookConfig.paddingBottomInPixels;
                document.body.style.setProperty("width", width + "px", "important");
                document.body.style.setProperty("height", height + "px", "important");
                document.body.style.setProperty("-webkit-column-width", width + "px", "important");
                document.body.style.setProperty("-webkit-column-gap", "0px", "important");
            },

            refreshTextAlign: function() {
                styles.p.setProperty("text-align", bookConfig.textAlign, "important");
                styles.div.setProperty("text-align", bookConfig.textAlign, "important");
                styles.td.setProperty("text-align", bookConfig.textAlign, "important");
                styles.dt.setProperty("text-align", bookConfig.textAlign, "important");
                styles.dd.setProperty("text-align", bookConfig.textAlign, "important");
                styles.br.setProperty("text-align", bookConfig.textAlign, "important");
                styles.li.setProperty("text-align", bookConfig.textAlign, "important");
            },

            refreshFontSize: function() {
                document.body.style.setProperty("font-size", bookConfig.fontSizeInPercents + "%", "important");
            },

            reflow: function() {
                refreshPageCount();
                refreshCurrentPage();
            }
        };

        function refreshTextModification() {
            var regexVars = {
                spaces: "\u0020\u00A0\u2000\u2001\u2002\u2002\u2004\u2005\u2006\u2007\u2008\u2009\u200A\u200B\u202F\u205F\u2060\u3000\u0009",
                lineBreaks: "\n\r\f"
            };

            function fregexp(pattern, flags, vars) {
                return vregexp(pattern, flags, vars ? mergeObjects(regexVars, vars) : regexVars);
            }

            var FORMAT_ELEMENTS = stringSet([
                "LABEL", "RUBY", "RT", "LI", "CAPTION", "TD", "TH", "INPUT", "BUTTON", "MARQUEE",
                "ARTICLE", "BLOCKQUOTE", "CENTER", "DT", "DD", "DETAILS", "DIV", "FIGCAPTION",
                "FOOTER", "H1", "H2", "H3", "H4", "H5", "H6", "HEADER", "LEGEND", "LISTING", "MAIN",
                "NAV", "OL", "OPTION", "P", "SECTION", "SUMMARY", "UL", "XMP"
            ]);

            iterateChildrenRecursively(document.body, function(node) {
                if (node.nodeType == Node.ELEMENT_NODE && FORMAT_ELEMENTS.contains(node.nodeName)) {
                    var text = elementText(node);
                    bookConfig.deleteRedundantSpaces && deleteRedundantSpaces(text);
                    bookConfig.replaceFixedSpaces && replaceFixedSpaces(text);
                }
            });

            function deleteRedundantSpaces(text) {
                deleteTrailingSpaces(text);
                deleteLeadingSpaces(text);

                // Удаляются пробелы в начале строки
                // "   Погода сегодня хорошая" будет заменно на "Погода сегодня хорошая"
                function deleteLeadingSpaces(text) {
                    text.find(
                        fregexp("^[%spaces%lineBreaks]+", "g"),
                        function(result) {
                            result.range().deleteContents();
                        }
                    );
                }

                // Удаляются пробелы в конце строки
                function deleteTrailingSpaces(text) {
                    text.find(
                        fregexp("[%spaces%lineBreaks]+$", "g"),
                        function(result) {
                            result.range().deleteContents();
                        }
                    );
                }
            }

            function replaceFixedSpaces(text) {
                replaceInDialog(text);

                // Заменяются пробелы в диалоге на фиксированные, чтобы при выравнивании по ширине они не разъезжались
                // "    -  Как дела?" будет заменено на "    -<span class='fixSpace'></span>Как дела?"
                function replaceInDialog(text) {
                    return text.find(
                        fregexp("(^[%spaces]*[%dashes])([%spaces]+)", "g", {
                            dashes: "\u2013\u2014\u2015\u002D"
                        }),
                        function(result) {
                            var range = result.range(result.subStrings[0].length);
                           // range.deleteContents();
                            //range.insertNode(document.createTextNode("&thinsp;"));
                            var span = document.createElement("span");
                            span.className = "fixSpace";
                            span.textContent = "\u00A0";
                            range.deleteContents();
                            range.insertNode(span);
                        }
                    );
                }
            }
        }

        frameReader.refreshPageConfiguration();
        frameReader.refreshTextAlign();
        frameReader.refreshFontSize();
        refreshTextModification();
        frameReader.reflow();

        function refreshPageCount() {
            var totalWidth = document.body.scrollWidth;
            frameReader.pageCount = screenWidth > 0 ? Math.round(totalWidth / screenWidth) : 0;
        }

        function refreshCurrentPage() {
            var totalWidth = document.body.scrollWidth;
            frameReader.currentPage = screenWidth > 0 ?
                    Math.min(Math.round(frameReader.currentPercent / ONE_HUNDRED_PERCENT * totalWidth / screenWidth),
                             frameReader.pageCount - 1) :
                    0;
            onSegmentPageChanged();
        }
    }
};

</script>

</body>
</html>